{"version":3,"sources":["../../../src/components/config/dsUpgrade.js"],"names":["_","DatasourceUpgrader","contextSrv","backendSrv","$q","datasourceSrv","apiKey","keyRequest","upgradeed","upgraded","datasources","getAll","raintank","exec","url","raintankEvents","hasRole","needsUpgrade","canUpgrade","configureDatasource","when","self","get","then","resp","meta","code","reject","body","results","graphite","elastic","forEach","ds","name","getDatasources","promises","type","access","basicAuth","basicAuthPassword","basicAuthUser","jsonData","push","getKey","post","isMatch","put","id","merge","database","esVersion","interval","timeField","all","datasourceConfig","settings","init","result"],"mappings":"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","file":"dsUpgrade.js","sourcesContent":["import _ from 'lodash' ;\n\nexport default class DatasourceUpgrader {\n  constructor(contextSrv, backendSrv, $q, datasourceSrv) {\n    this.backendSrv = backendSrv;\n    this.contextSrv = contextSrv;\n    this.datasourceSrv = datasourceSrv;\n    this.$q = $q;\n    this.apiKey = \"\";\n    this.keyRequest = null;\n    this.upgradeed = false;\n  }\n\n  needsUpgrade() {\n    if (this.upgraded) {\n      return false;\n    }\n\n    if (!this.datasourceSrv) {\n      return false;\n    }\n\n    var datasources = this.datasourceSrv.getAll();\n\n    if (!datasources.raintank || !/^\\/api\\/datasources\\/proxy/.exec(datasources.raintank.url)) {\n      return true;\n    }\n\n    if (!datasources.raintankEvents || !/^\\/api\\/datasources\\/proxy/.exec(datasources.raintankEvents.url)) {\n      return true;\n    }\n\n    return false;\n  }\n\n  canUpgrade() {\n    // only admins can modify datasources.\n    return this.contextSrv.hasRole(\"Admin\");\n  }\n\n  upgrade() {\n    if (this.needsUpgrade() && this.canUpgrade()) {\n      return this.configureDatasource();\n    } else {\n      return this.$q.when();\n    }\n  }\n\n  getKey() {\n    // if we have already fetched the key, they just return it.\n    if (this.apiKey !== \"\") {\n      return this.$q.when(this.apiKey);\n    }\n    // if we are currently fetching the key, then just return the promise.\n    // when it resolves, it will provide the key.\n    if (this.keyRequest) {\n      return this.keyRequest;\n    }\n\n    // fetch the key from the worldping-api\n    var self = this;\n    this.keyRequest = this.backendSrv.get('api/plugin-proxy/raintank-worldping-app/_key')\n    .then((resp) => {\n      if (resp.meta.code !== 200) {\n        return self.$q.reject(\"failed to get current apiKey\");\n      }\n      return resp.body.apiKey;\n    });\n    return this.keyRequest;\n  }\n\n  getDatasources() {\n    var self = this;\n    //check for existing datasource.\n    return self.backendSrv.get('/api/datasources')\n    .then((results) => {\n      var datasources = {\n        graphite: null,\n        elastic: null\n      };\n      _.forEach(results, function(ds) {\n        if (ds.name === \"raintank\") {\n          datasources.graphite = ds;\n        }\n        if (ds.name === \"raintankEvents\") {\n          datasources.elastic = ds;\n        }\n      });\n      return datasources;\n    });\n  }\n\n  configureDatasource() {\n    var self = this;\n    //check for existing datasource.\n    return this.getDatasources().then((datasources) => {\n      var promises = [];\n      var graphite = {\n        name: 'raintank',\n        type: 'graphite',\n        url: 'https://tsdb-gw.raintank.io/graphite/',\n        access: 'proxy',\n        basicAuth: true,\n        basicAuthPassword: \"\",\n        basicAuthUser: \"\",\n        jsonData: {}\n      };\n      if (!datasources.graphite) {\n        // create datasource.\n        promises.push(self.getKey().then((apiKey) => {\n          graphite.basicAuthUser = \"api_key\";\n          graphite.basicAuthPassword = apiKey;\n          return self.backendSrv.post('/api/datasources', graphite);\n        }));\n      } else if (!_.isMatch(datasources.graphite, graphite)) {\n        // update datasource if necessary\n        promises.push(self.getKey().then((apiKey) => {\n          graphite.basicAuthUser = \"api_key\";\n          graphite.basicAuthPassword = apiKey;\n          return self.backendSrv.put('/api/datasources/' + datasources.graphite.id, _.merge({}, datasources.graphite, graphite));\n        }));\n      }\n\n      var elastic = {\n        name: 'raintankEvents',\n        type: 'elasticsearch',\n        url: 'https://tsdb-gw.raintank.io/elasticsearch/',\n        access: 'proxy',\n        basicAuth: true,\n        basicAuthPassword: \"\",\n        basicAuthUser: \"\",\n        database: '[events-]YYYY-MM-DD',\n        jsonData: {\n          esVersion: 2,\n          interval: \"Daily\",\n          timeField: \"timestamp\"\n        }\n      };\n\n      if (!datasources.elastic) {\n        // create datasource.\n        promises.push(self.getKey().then((apiKey) => {\n          elastic.basicAuthUser = \"api_key\";\n          elastic.basicAuthPassword = apiKey;\n          return self.backendSrv.post('/api/datasources', elastic);\n        }));\n      } else if (!_.isMatch(datasources.elastic, elastic)) {\n        // update datasource if necessary\n        promises.push(self.getKey().then((apiKey) => {\n          elastic.basicAuthUser = \"api_key\";\n          elastic.basicAuthPassword = apiKey;\n          return self.backendSrv.put('/api/datasources/' + datasources.elastic.id, _.merge({}, datasources.elastic, elastic));\n        }));\n      }\n\n      return self.$q.all(promises);\n    }).then(result => {\n      self.upgraded = true;\n\n      return this.backendSrv.get('/api/frontend/settings').then(settings => {\n        // update datasource config\n        var datasourceConfig = this.datasourceSrv.getAll();\n        datasourceConfig.raintank = settings.datasources.raintank;\n        datasourceConfig.raintankEvents = settings.datasources.raintankEvents;\n        this.datasourceSrv.init();\n\n        return result;\n      });\n    });\n  }\n}"]}