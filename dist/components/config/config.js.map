{"version":3,"sources":["../../../src/components/config/config.js"],"names":[],"mappings":"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","file":"config.js","sourcesContent":["import configTemplate from './config.html!text';\n\nimport _ from 'lodash' ;\n\nclass WorldPingConfigCtrl {\n  constructor($scope, $injector, $q, backendSrv, alertSrv) {\n    this.$q = $q;\n    this.backendSrv = backendSrv;\n    this.alertSrv = alertSrv;\n    this.validKey = false;\n    this.quotas = {};\n    this.appEditCtrl.setPreUpdateHook(this.preUpdate.bind(this));\n    this.appEditCtrl.setPostUpdateHook(this.postUpdate.bind(this));\n\n    if (this.appModel.jsonData === null) {\n      this.appModel.jsonData = {};\n    }\n    if (!this.appModel.secureJsonData) {\n      this.appModel.secureJsonData = {};\n    }\n    if (this.appModel.enabled) {\n      this.validateKey();\n    }\n  }\n\n  reset() {\n    this.appModel.jsonData.apiKeySet=false;\n    this.validKey = false;\n  }\n\n  validateKey() {\n    var self = this;\n    var p = this.backendSrv.get('api/plugin-proxy/raintank-worldping-app/api/v2/quotas');\n    p.then((resp) => {\n      if (resp.meta.code !== 200) {\n        self.alertSrv.set(\"failed to get Quotas\", resp.message, 'error', 10000);\n        return self.$q.reject(resp.message);\n      }\n      self.validKey = true;\n      self.quotas = resp.body;\n    }, (resp) => {\n      if (self.appModel.enabled) {\n        self.alertSrv.set(\"failed to verify apiKey\", resp.statusText, 'error', 10000);\n        self.appModel.enabled = false;\n        self.appModel.jsonData.apiKeySet = false;\n        self.appModel.secureJsonData.apiKey = \"\";\n        self.errorMsg = \"invalid apiKey\";\n        this.validKey = false;\n      }\n    });\n    return p;\n  }\n\n  preUpdate() {\n    var model = this.appModel;\n    if (!model.enabled) {\n      return this.$q.resolve();\n    }\n\n    if (!model.jsonData.apiKeySet && !model.secureJsonData.apiKey) {\n      model.enabled = false;\n      this.errorMsg = \"apiKey not set\";\n      this.validKey = false;\n      return this.$q.reject(\"apiKey not set.\");\n    }\n    model.jsonData.apiKeySet = true;\n    return this.initDatasource();\n  }\n\n  postUpdate() {\n    if (!this.appModel.enabled) {\n      return this.$q.resolve();\n    }\n    var self = this;\n    return this.validateKey()\n    .then(() => {\n      return self.appEditCtrl.importDashboards().then(() => {\n        return {\n          url: \"dashboard/db/worldping-home\",\n          message: \"worldPing app installed!\"\n        };\n      });\n    });\n  }\n\n  configureDatasource() {\n    this.appModel.jsonData.datasourceSet = false;\n    this.initDatasource().then(() => {\n      this.appModel.jsonData.datasourceSet = true;\n    });\n  }\n\n  initDatasource() {\n    var self = this;\n    //check for existing datasource.\n    var p = self.backendSrv.get('/api/datasources');\n    p.then(function(results) {\n      var foundGraphite = false;\n      var foundElastic = false;\n      _.forEach(results, function(ds) {\n        if (foundGraphite && foundElastic) { return; }\n        if (ds.name === \"raintank\") {\n          foundGraphite = true;\n        }\n        if (ds.name === \"raintankEvents\") {\n          foundElastic = true;\n        }\n      });\n      var promises = [];\n      if (!foundGraphite) {\n        // create datasource.\n        var graphite = {\n          name: 'raintank',\n          type: 'graphite',\n          url: 'api/plugin-proxy/raintank-worldping-app/api/graphite',\n          access: 'direct',\n          jsonData: {}\n        };\n        promises.push(self.backendSrv.post('/api/datasources', graphite));\n      }\n      if (!foundElastic) {\n        // create datasource.\n        var elastic = {\n          name: 'raintankEvents',\n          type: 'elasticsearch',\n          url: 'api/plugin-proxy/raintank-worldping-app/api/elasticsearch',\n          access: 'direct',\n          database: '[events-]YYYY-MM-DD',\n          jsonData: {\n            esVersion: 1,\n            interval: \"Daily\",\n            timeField: \"timestamp\"\n          }\n        };\n        promises.push(self.backendSrv.post('/api/datasources', elastic));\n      }\n      return self.$q.all(promises);\n    });\n    return p;\n  }\n}\n\nWorldPingConfigCtrl.template = configTemplate;\n\nexport {\n  WorldPingConfigCtrl as ConfigCtrl\n};\n"]}